<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>雙贏策略｜配息試算＋投組年化分析（快速帶入到 A~E）</title>
<style>
  :root{
    --deep:#0A1221; --gold:#C9A227; --gold-soft:#E9D18A;
    --card:#0C152A; --pos:#39C27A; --neg:#E25A5A;
    --field-bg:#101b33; --input-bg:#071226; --line:rgba(233,209,138,.25);
    --overlay: rgba(0,0,0,.55);
  }
  html,body{margin:0;background:var(--deep);color:#fff;font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .tabs{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .tablist{display:flex;gap:8px;flex-wrap:wrap}
  .tab{
    padding:10px 14px;border-radius:10px;border:1px solid rgba(201,162,39,.35);
    background:linear-gradient(180deg,rgba(12,21,42,.9),rgba(12,21,42,.75));
    color:#E9D18A; cursor:pointer; font-weight:700; letter-spacing:.3px; transition:.2s;
  }
  .tab[aria-selected="true"]{ background:linear-gradient(90deg,var(--gold),var(--gold-soft)); color:#0A1221; border-color:transparent; box-shadow:0 6px 16px rgba(233,209,138,.25) }
  .export{display:flex;gap:8px;flex-wrap:wrap}
  .btn{
    padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700;color:#0A1221;
    background:linear-gradient(90deg,var(--gold),var(--gold-soft)); box-shadow:0 6px 16px rgba(233,209,138,.25); transition:.2s
  }
  .btn:hover{transform:translateY(-2px); box-shadow:0 10px 20px rgba(233,209,138,.35)}

  .hero,.panel{
    border:1px solid rgba(201,162,39,.40); border-radius:16px; padding:24px; margin-bottom:20px;
    background:linear-gradient(180deg,rgba(10,18,33,.95),rgba(10,18,33,.7));
    box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(233,209,138,.08);
    transition:transform .25s, box-shadow .25s;
  }
  .hero:hover,.panel:hover{ transform:translateY(-2px); box-shadow:0 12px 28px rgba(0,0,0,.45), inset 0 0 0 1px rgba(233,209,138,.10) }

  .title{
    margin:0 0 8px;font-weight:700;font-size:22px;
    background:linear-gradient(90deg,var(--gold),var(--gold-soft));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    -webkit-text-fill-color: transparent;
  }
  .subtitle{margin:0 0 16px;color:#d7dbe7;font-size:14px}
  .exporting .title{ background:none!important; -webkit-background-clip:initial!important; background-clip:initial!important; -webkit-text-fill-color:initial!important; color:var(--gold)!important; }

  .form{max-width:820px;margin:0 auto}
  .form-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .field{
    min-width:0;background:var(--field-bg);border:1px solid rgba(201,162,39,.18);
    border-radius:12px;padding:12px;box-sizing:border-box; transition:transform .2s, box-shadow .2s, border-color .2s;
  }
  .field:hover{ transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,.35); border-color:rgba(201,162,39,.28) }
  .field label{display:block;margin-bottom:8px;font-size:13px;color:#E9D18A;letter-spacing:.2px}
  .control{
    display:block;width:100%;height:44px;line-height:44px;padding:0 12px;box-sizing:border-box;min-width:0;
    border-radius:10px;border:1px solid rgba(233,209,138,.12);background:var(--input-bg);color:#fff;font-size:16px;outline:none;
    transition:box-shadow .2s,border-color .2s, transform .15s;
  }
  .control:focus{box-shadow:0 0 0 3px rgba(201,162,39,.18); border-color:rgba(233,209,138,.35); transform:translateY(-1px) }
  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}

  table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden;background:var(--card);
    box-shadow:0 0 8px rgba(0,0,0,.25), inset 0 0 0 1px rgba(233,209,138,.05)}
  th,td{padding:12px 14px;text-align:left}
  th{font-size:13px;color:var(--gold-soft);
     background:linear-gradient(90deg, rgba(201,162,39,.15), rgba(10,18,33,0));
     border-bottom:2px solid rgba(201,162,39,.8);letter-spacing:.5px}
  td{font-size:16px;color:#f5f5f5;border-bottom:1px solid var(--line);transition:background .2s, transform .2s}
  tbody tr:hover{background:rgba(233,209,138,.08); transform:translateY(-1px)}
  td:first-child{color:var(--gold-soft);font-weight:500}
  .em{font-weight:700;color:#fff}
  .pos{color:var(--pos);font-weight:700}
  .neg{color:var(--neg);font-weight:700}
  .gold{color:var(--gold);font-weight:700}
  .muted{color:#bfc6d6}

  .tabpanel{display:none}
  .tabpanel.active{display:block}

  /* Modal */
  .modal{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .modal.show{display:flex}
  .modal-card{max-width:900px;width:100%;background:var(--card);border:1px solid rgba(201,162,39,.35);border-radius:14px;box-shadow:0 12px 36px rgba(0,0,0,.5);padding:16px}
  .modal-card h3{margin:0 0 8px;color:var(--gold-soft)}
  .modal-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:8px}
  .textarea{
    width:100%;height:360px;background:var(--input-bg);border:1px solid rgba(233,209,138,.12);
    color:#fff;border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size:13px;line-height:1.5;resize:vertical;
  }

  @media (max-width:720px){ .form{max-width:100%} }
</style>
</head>
<body>
<div class="wrap">

  <div class="tabs" role="tablist" aria-label="試算功能">
    <div class="tablist">
      <button class="tab" role="tab" id="tab-cash" aria-controls="panel-cash" aria-selected="true">每月配息試算</button>
      <button class="tab" role="tab" id="tab-portfolio" aria-controls="panel-portfolio" aria-selected="false">投組年化分析</button>
    </div>
    <div class="export">
      <button class="btn" id="btnCatalog">管理常用基金</button>
      <button class="btn" id="btnPng">匯出 PNG</button>
      <button class="btn" id="btnPdf">匯出 PDF</button>
    </div>
  </div>

  <!-- Panel 1 -->
  <section class="tabpanel active" id="panel-cash" role="tabpanel" aria-labelledby="tab-cash">
    <section class="hero">
      <h1 class="title">雙贏策略｜每月配息試算</h1>
      <p class="subtitle">預估報酬率（含息）＝ [(投入總額 × 年化配息率) − (融資金額 × 融資利率)] ÷ 投入本金</p>
      <div class="form">
        <div class="form-grid">
          <div class="field"><label for="principal">投入本金（$）</label><input id="principal" type="number" class="control" value="1000000"></div>
          <div class="field"><label for="loan">融資金額（$）</label><input id="loan" type="number" class="control" value="1500000"></div>
          <div class="field">
            <label for="ratio">融資成數</label>
            <select id="ratio" class="control">
              <option value="0|0.0000">0 成</option><option value="0.1|0.1111111111">1 成</option>
              <option value="0.2|0.25">2 成</option><option value="0.3|0.4285714286">3 成</option>
              <option value="0.4|0.6666666667">4 成</option><option value="0.5|1.0">5 成</option>
              <option value="0.6|1.5" selected>6 成</option><option value="custom|custom">自訂</option>
            </select>
          </div>
          <div class="field"><label for="rate">年化配息率（%）</label><input id="rate" type="number" class="control" value="10.0" step="0.01"></div>
          <div class="field"><label for="loanRate">融資年利率（%）</label><input id="loanRate" type="number" class="control" value="4.00" step="0.01"></div>
        </div>
      </div>

      <div class="panel" style="margin-top:16px">
        <table>
          <thead><tr><th>項目</th><th>金額 / 比率</th></tr></thead>
          <tbody>
            <tr><td>投入本金</td><td id="vPrincipal">—</td></tr>
            <tr><td>融資成數</td><td id="vRatio">—</td></tr>
            <tr><td>融資金額</td><td id="vLoan">—</td></tr>
            <tr><td>投入總額（本金＋融資）</td><td id="vTotal" class="em">—</td></tr>
            <tr><td>年化配息率</td><td id="vRate">—</td></tr>
            <tr><td>每月配息（估）</td><td id="vMonthlyDiv" class="pos">—</td></tr>
            <tr><td>每月利息支出</td><td id="vMonthlyInt" class="neg">—</td></tr>
            <tr><td>每月淨現金流</td><td id="vMonthlyNet" class="em">—</td></tr>
            <tr><td>預估報酬率（含息，年化）</td><td id="vEstReturn" class="gold">—</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </section>

  <!-- Panel 2 -->
  <section class="tabpanel" id="panel-portfolio" role="tabpanel" aria-labelledby="tab-portfolio">
    <section class="panel">
      <h1 class="title">投資組合｜1/3/5 年年化（CAGR）與配息拆解</h1>
      <p class="subtitle">輸入每檔基金的「近 1/3/5 年累積報酬率(%)」與「配息率(%)」、配置比例(%)。系統年化為 CAGR，並估計「資本成長率 = CAGR − 配息率」，再依配置加權得到投組指標。</p>

      <!-- 鏡射：融資年利率 -->
      <div class="form" style="margin-bottom:8px;">
        <div class="form-grid">
          <div class="field">
            <label>融資年利率（%）— 由《每月配息試算》同步</label>
            <input id="loanRateMirror" class="control" type="number" step="0.01" value="0" disabled />
          </div>
        </div>
      </div>

      <!-- 工具列：快速帶入常用基金 → 指定帶入 A~E -->
      <div class="panel" style="margin-top:0;margin-bottom:12px;padding:16px">
        <div class="form-grid" style="grid-template-columns:2fr 1fr auto;">
          <div class="field">
            <label for="presetSelect">常用基金清單</label>
            <select id="presetSelect" class="control">
              <option value="">— 選擇常用基金 —</option>
            </select>
          </div>
          <div class="field">
            <label for="targetRow">帶入到哪一列</label>
            <select id="targetRow" class="control">
              <option value="0">基金A</option>
              <option value="1">基金B</option>
              <option value="2">基金C</option>
              <option value="3">基金D</option>
              <option value="4">基金E</option>
            </select>
          </div>
          <div class="field" style="display:flex;align-items:flex-end">
            <button class="btn" id="applyPresetBtn" style="width:100%">帶入</button>
          </div>
        </div>
      </div>

      <!-- Input: 5 funds（保留手動輸入） -->
      <table id="fundInputTable">
        <thead>
          <tr>
            <th>基金名稱</th>
            <th>近1年報酬(%)</th>
            <th>近3年報酬(%)</th>
            <th>近5年報酬(%)</th>
            <th>配息率(%)</th>
            <th>配置比例(%)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input class="control name" type="text" placeholder="基金A"></td>
            <td><input class="control fin r1" type="number" step="0.01"></td>
            <td><input class="control fin r3" type="number" step="0.01"></td>
            <td><input class="control fin r5" type="number" step="0.01"></td>
            <td><input class="control fin dy" type="number" step="0.01"></td>
            <td><input class="control fin wt" type="number" step="0.01"></td>
          </tr>
          <tr>
            <td><input class="control name" type="text" placeholder="基金B"></td>
            <td><input class="control fin r1" type="number" step="0.01"></td>
            <td><input class="control fin r3" type="number" step="0.01"></td>
            <td><input class="control fin r5" type="number" step="0.01"></td>
            <td><input class="control fin dy" type="number" step="0.01"></td>
            <td><input class="control fin wt" type="number" step="0.01"></td>
          </tr>
          <tr>
            <td><input class="control name" type="text" placeholder="基金C"></td>
            <td><input class="control fin r1" type="number" step="0.01"></td>
            <td><input class="control fin r3" type="number" step="0.01"></td>
            <td><input class="control fin r5" type="number" step="0.01"></td>
            <td><input class="control fin dy" type="number" step="0.01"></td>
            <td><input class="control fin wt" type="number" step="0.01"></td>
          </tr>
          <tr>
            <td><input class="control name" type="text" placeholder="基金D"></td>
            <td><input class="control fin r1" type="number" step="0.01"></td>
            <td><input class="control fin r3" type="number" step="0.01"></td>
            <td><input class="control fin r5" type="number" step="0.01"></td>
            <td><input class="control fin dy" type="number" step="0.01"></td>
            <td><input class="control fin wt" type="number" step="0.01"></td>
          </tr>
          <tr>
            <td><input class="control name" type="text" placeholder="基金E"></td>
            <td><input class="control fin r1" type="number" step="0.01"></td>
            <td><input class="control fin r3" type="number" step="0.01"></td>
            <td><input class="control fin r5" type="number" step="0.01"></td>
            <td><input class="control fin dy" type="number" step="0.01"></td>
            <td><input class="control fin wt" type="number" step="0.01"></td>
          </tr>
        </tbody>
      </table>

      <!-- Outputs per fund -->
      <div class="panel" style="margin-top:16px">
        <table id="fundOutputTable">
          <thead>
            <tr>
              <th>基金</th>
              <th>CAGR(1年)</th>
              <th>CAGR(3年)</th>
              <th>CAGR(5年)</th>
              <th>CAGR(3年) − 配息率</th>
              <th>估計資本成長率(1年)</th>
              <th>估計資本成長率(3年)</th>
              <th>估計資本成長率(5年)</th>
            </tr>
          </thead>
          <tbody id="fundRows"></tbody>
        </table>
      </div>

      <!-- Portfolio summary -->
      <div class="panel" style="margin-top:16px">
        <table>
          <thead><tr><th>投資組合指標（加權年化）</th><th>1年</th><th>3年</th><th>5年</th></tr></thead>
          <tbody>
            <tr>
              <td>含息報酬率（CAGR，加權平均）</td>
              <td id="pf_cagr1" class="gold">—</td>
              <td id="pf_cagr3" class="gold">—</td>
              <td id="pf_cagr5" class="gold">—</td>
            </tr>
            <tr>
              <td>配息率（加權平均）</td>
              <td id="pf_div1" class="pos">—</td>
              <td id="pf_div3" class="pos">—</td>
              <td id="pf_div5" class="pos">—</td>
            </tr>
            <tr>
              <td>資本成長率（含息 − 配息）</td>
              <td id="pf_cap1" class="em">—</td>
              <td id="pf_cap3" class="em">—</td>
              <td id="pf_cap5" class="em">—</td>
            </tr>
            <tr>
              <td>融資水位（%）</td>
              <td id="pf_ltv1" class="em">—</td>
              <td id="pf_ltv3" class="em">—</td>
              <td id="pf_ltv5" class="em">—</td>
            </tr>
          </tbody>
        </table>
        <p class="muted" style="margin-top:8px">※ 近 3/5 年為「累積報酬率 → 幾何年化」；近 1 年即當年報酬。融資水位依單利＆次次年併本；LTV > 80% 標紅。常用基金資料可於右上「管理常用基金」維護。</p>
      </div>
    </section>
  </section>

  <p class="muted" style="font-size:12px">⚠️ 本頁僅為試算與教育用途，非投資建議。歷史績效不代表未來表現。</p>
</div>

<!-- Modal: Catalog Editor -->
<div class="modal" id="catalogModal" aria-hidden="true">
  <div class="modal-card">
    <h3>管理常用基金（JSON）</h3>
    <p class="muted" style="margin:6px 0 10px">欄位：<code>id</code>、<code>name</code>、<code>r1</code>（近1年%）、<code>r3</code>/<code>r5</code>（近3/5年累積%）、<code>dy</code>（配息率%）。</p>
    <textarea id="catalogEditor" class="textarea" spellcheck="false"></textarea>
    <div class="modal-actions">
      <input type="file" id="catalogImport" accept="application/json" style="display:none">
      <button class="btn" id="btnImport">匯入 JSON</button>
      <button class="btn" id="btnExport">匯出 JSON</button>
      <button class="btn" id="btnCancel">取消</button>
      <button class="btn" id="btnSave">儲存</button>
    </div>
  </div>
</div>

<!-- 內建預設資料（當 localStorage 與 /fund-catalog.json 都沒有時使用） -->
<script id="fundCatalog" type="application/json">
[
  {
    "id": "ALLIANZ_AM_USD_AMM",
    "name": "安聯收益成長基金-AM穩定月收類股(美元)",
    "r1": 11.00,
    "r3": 31.88,
    "r5": 34.80,
    "dy": 9.00
  },
  {
    "id": "MONEYDJ_TLZ64",
    "name": "（MoneyDJ 範例）基金X",
    "r1": 11.01,
    "r3": 39.85,
    "r5": 38.24,
    "dy": 6.00
  }
]
</script>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ============ Tabs ============ */
const tabs = {
  cash:{tab:document.getElementById('tab-cash'),panel:document.getElementById('panel-cash')},
  pf:{tab:document.getElementById('tab-portfolio'),panel:document.getElementById('panel-portfolio')}
};
function setTab(which){
  Object.values(tabs).forEach(o=>{o.tab.setAttribute('aria-selected','false');o.panel.classList.remove('active')});
  tabs[which].tab.setAttribute('aria-selected','true'); tabs[which].panel.classList.add('active');
}
tabs.cash.tab.addEventListener('click',()=>setTab('cash'));
tabs.pf.tab.addEventListener('click',()=>setTab('pf'));

/* ============ Utils ============ */
const $=id=>document.getElementById(id);
const fmtPct=n=>isFinite(n)?(n*100).toFixed(2)+'%':'—';
function cagrFromTotalPct(totalPct,years){const x=parseFloat(totalPct); if(!isFinite(x)) return NaN; const dec=x/100; if(dec<=-1||years<=0) return NaN; return Math.pow(1+dec,1/years)-1;}
function twd(n){return new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',maximumFractionDigits:0}).format(n);}
function num(el){const v=parseFloat((el.value||'').toString().replace(/,/g,'')); return isFinite(v)?v:0;}

/* ============ Catalog ============ */
let FUND_CATALOG=[];
async function loadCatalog(){
  const ls=localStorage.getItem('fundCatalog');
  if(ls){ try{FUND_CATALOG=JSON.parse(ls); return;}catch(e){} }
  try{ const res=await fetch('/fund-catalog.json',{cache:'no-store'}); if(res.ok){FUND_CATALOG=await res.json(); return;} }catch(e){}
  try{ FUND_CATALOG=JSON.parse(document.getElementById('fundCatalog').textContent.trim()); }catch(e){ FUND_CATALOG=[]; }
}
function saveCatalogToLocal(){ localStorage.setItem('fundCatalog', JSON.stringify(FUND_CATALOG, null, 2)); }
function populatePresetSelect(){
  const sel=$('presetSelect');
  sel.innerHTML = `<option value="">— 選擇常用基金 —</option>` + FUND_CATALOG.map(f=>`<option value="${f.id}">${f.name}</option>`).join('');
}
function findPreset(id){ return FUND_CATALOG.find(f=>f.id===id); }
function applyPresetToRow(rowIdx, presetId){
  const preset=findPreset(presetId); if(!preset) return;
  const tr=document.querySelectorAll('#fundInputTable tbody tr')[rowIdx]; if(!tr) return;
  tr.querySelector('.name').value = preset.name || '';
  tr.querySelector('.r1').value   = (preset.r1 ?? '');
  tr.querySelector('.r3').value   = (preset.r3 ?? '');
  tr.querySelector('.r5').value   = (preset.r5 ?? '');
  tr.querySelector('.dy').value   = (preset.dy ?? '');
  // wt 不改
  recomputePortfolio();
}

/* Modal */
const modal=$('catalogModal'), editor=$('catalogEditor');
$('btnCatalog').addEventListener('click',()=>{ editor.value=JSON.stringify(FUND_CATALOG,null,2); modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); });
$('btnCancel').addEventListener('click',()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); });
$('btnSave').addEventListener('click',()=>{
  try{
    const arr=JSON.parse(editor.value); if(!Array.isArray(arr)) throw new Error('必須是陣列');
    arr.forEach((f,i)=>{ if(!f.id||!f.name) throw new Error(`第 ${i+1} 筆缺少 id/name`); });
    FUND_CATALOG=arr; saveCatalogToLocal(); populatePresetSelect(); modal.classList.remove('show'); modal.setAttribute('aria-hidden','true');
  }catch(err){ alert('JSON 格式錯誤：'+err.message); }
});
$('btnExport').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(FUND_CATALOG,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='fund-catalog.json'; a.click(); URL.revokeObjectURL(a.href);
});
$('btnImport').addEventListener('click',()=>$('catalogImport').click());
$('catalogImport').addEventListener('change',(e)=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{ try{ const arr=JSON.parse(reader.result); if(!Array.isArray(arr)) throw new Error('必須是陣列'); FUND_CATALOG=arr; editor.value=JSON.stringify(FUND_CATALOG,null,2); populatePresetSelect(); }catch(err){ alert('匯入失敗：'+err.message); } };
  reader.readAsText(file);
});

/* ============ Portfolio tables ============ */
const inputTbody=document.querySelector('#fundInputTable tbody');
const outputBody=$('fundRows');
const defaultNames=['基金A','基金B','基金C','基金D','基金E'];

function readFundRows(){
  return Array.from(inputTbody.querySelectorAll('tr')).map((tr,idx)=>{
    const name=(tr.querySelector('.name')?.value||'').trim()||defaultNames[idx];
    const r1=parseFloat(tr.querySelector('.r1')?.value);
    const r3=parseFloat(tr.querySelector('.r3')?.value);
    const r5=parseFloat(tr.querySelector('.r5')?.value);
    const dy=parseFloat(tr.querySelector('.dy')?.value);
    const wt=parseFloat(tr.querySelector('.wt')?.value);
    return {name,r1,r3,r5,dy,wt};
  });
}
function cagrRow(f){
  const c1=isFinite(f.r1)?(f.r1/100):NaN;
  const c3=isFinite(f.r3)?cagrFromTotalPct(f.r3,3):NaN;
  const c5=isFinite(f.r5)?cagrFromTotalPct(f.r5,5):NaN;
  const dy=isFinite(f.dy)?(f.dy/100):NaN;
  const cap1=(isFinite(c1)&&isFinite(dy))?c1-dy:NaN;
  const cap3=(isFinite(c3)&&isFinite(dy))?c3-dy:NaN;
  const cap5=(isFinite(c5)&&isFinite(dy))?c5-dy:NaN;
  const diff3=cap3;
  return {c1,c3,c5,dy,cap1,cap3,cap5,diff3};
}
function spanPct(value){ if(!isFinite(value)) return '—'; const cls=value<0?'neg':''; return `<span class="${cls}">${(value*100).toFixed(2)}%</span>`; }
function renderRows(rows){
  outputBody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.name}</td>
      <td>${spanPct(r.c1)}</td>
      <td>${spanPct(r.c3)}</td>
      <td>${spanPct(r.c5)}</td>
      <td>${spanPct(r.diff3)}</td>
      <td>${spanPct(r.cap1)}</td>
      <td>${spanPct(r.cap3)}</td>
      <td>${spanPct(r.cap5)}</td>
    `;
    outputBody.appendChild(tr);
  });
}

/* ============ 融資水位 ============ */
function outstandingSeries(P0,r,N=5){
  const B={},I={},O={};
  for(let t=1;t<=N;t++){
    if(t<=2){B[t]=P0;} else {let s=0; for(let k=1;k<=t-2;k++) s+=I[k]; B[t]=P0+s;}
    I[t]=B[t]*r; O[t]=B[t]+I[t]+(t>=2?I[t-1]:0);
  }
  return {B,I,O};
}
function updateLTVRow(cap1,cap3,cap5){
  const P=num($('principal')), L=num($('loan'));
  const i=(parseFloat($('loanRate').value)||0)/100;
  const V0=P+L, P0=L, r=i;
  if(!(P0>0&&V0>0)){ ['pf_ltv1','pf_ltv3','pf_ltv5'].forEach(id=>{ $(id).textContent='—'; $(id).classList.remove('neg');}); return; }
  const {O}=outstandingSeries(P0,r,5);
  const ltv=(g,n)=>{ if(!isFinite(g)) return NaN; const Vn=V0*Math.pow(1+g,n); return (O[n]/Vn)*100; };
  const l1=ltv(cap1,1), l3=ltv(cap3,3), l5=ltv(cap5,5);
  const fmt=v=>isFinite(v)?v.toFixed(2)+'%':'—';
  $('pf_ltv1').textContent=fmt(l1); $('pf_ltv3').textContent=fmt(l3); $('pf_ltv5').textContent=fmt(l5);
  const paint=(id,v)=>{const el=$(id); el.classList.remove('neg'); if(isFinite(v)&&v>80) el.classList.add('neg');};
  paint('pf_ltv1',l1); paint('pf_ltv3',l3); paint('pf_ltv5',l5);
}

/* ============ 投組匯總 ============ */
function calcPortfolio(rows){
  const valid=rows.filter(f=>isFinite(f.wt)&&f.wt>0);
  const sumW=valid.reduce((s,f)=>s+f.wt,0);
  const norm=valid.map(f=>({...f,w:(sumW>0?f.wt/sumW:0)}));
  const wAvg=fn=>{let acc=0,ws=0; norm.forEach(f=>{const v=fn(f); if(isFinite(v)){acc+=v*f.w; ws+=f.w;}}); return ws>0?acc:NaN;};

  const c1=wAvg(f=>f.c1), c3=wAvg(f=>f.c3), c5=wAvg(f=>f.c5), dy=wAvg(f=>f.dy);
  const cap1=(isFinite(c1)&&isFinite(dy))?c1-dy:NaN;
  const cap3=(isFinite(c3)&&isFinite(dy))?c3-dy:NaN;
  const cap5=(isFinite(c5)&&isFinite(dy))?c5-dy:NaN;

  $('pf_cagr1').textContent=isFinite(c1)?(c1*100).toFixed(2)+'%':'—';
  $('pf_cagr3').textContent=isFinite(c3)?(c3*100).toFixed(2)+'%':'—';
  $('pf_cagr5').textContent=isFinite(c5)?(c5*100).toFixed(2)+'%':'—';
  const dyTxt=isFinite(dy)?(dy*100).toFixed(2)+'%':'—';
  ['pf_div1','pf_div3','pf_div5'].forEach(id=>$(id).textContent=dyTxt);
  [['pf_cap1',cap1],['pf_cap3',cap3],['pf_cap5',cap5]].forEach(([id,val])=>{ const el=$(id); el.textContent=isFinite(val)?(val*100).toFixed(2)+'%':'—'; el.classList.toggle('neg',isFinite(val)&&val<0); });
  updateLTVRow(cap1,cap3,cap5);
}
function recomputePortfolio(){
  const raw=readFundRows();
  const calc=raw.map(f=>({...f,...cagrRow(f)}));
  renderRows(calc);
  calcPortfolio(calc);
}

/* 綁定：基金輸入（A~E） */
function bindFundInputs(){
  document.querySelectorAll('#fundInputTable .control').forEach(el=>{
    ['input','change'].forEach(evt=>el.addEventListener(evt,recomputePortfolio));
  });
}

/* ============ Cashflow ============ */
const principalEl=$('principal'),loanEl=$('loan'),ratioEl=$('ratio'),rateEl=$('rate'),loanRateEl=$('loanRate');
function parseRatioValue(val){ if(!val||val==='custom'||val==='custom|custom') return null; const p=val.split('|'); return p.length>=2?{ratio:parseFloat(p[0]),mult:parseFloat(p[1])}:null; }
let autoApplied=true;
function computeCashflow(){
  const P=num(principalEl); let L=num(loanEl);
  const r=parseFloat(rateEl.value)||0; const i=parseFloat(loanRateEl.value)||0;
  const ratioObj=parseRatioValue(ratioEl.value);
  if(ratioObj&&isFinite(ratioObj.mult)){
    const calcLoan=Math.round(P*ratioObj.mult);
    if(autoApplied||num(loanEl)===0||num(loanEl)===calcLoan){ L=calcLoan; loanEl.value=L; autoApplied=true; }
  }
  const total=P+L, annualDiv=total*(r/100), annualInt=L*(i/100);
  const mDiv=annualDiv/12, mInt=annualInt/12, mNet=mDiv-mInt;
  const estReturnPct=(P>0)?((annualDiv-annualInt)/P):NaN;

  $('vPrincipal').textContent=twd(P);
  $('vLoan').textContent=twd(L);
  $('vTotal').textContent=twd(total);
  $('vRate').textContent=r.toFixed(2)+'%';
  $('vMonthlyDiv').textContent=twd(mDiv);
  $('vMonthlyInt').textContent=twd(mInt);
  const netEl=$('vMonthlyNet'); netEl.textContent=twd(mNet); netEl.classList.toggle('pos',mNet>=0); netEl.classList.toggle('neg',mNet<0);
  $('vEstReturn').textContent=isFinite(estReturnPct)?(estReturnPct*100).toFixed(2)+'%':'—';
  $('vRatio').textContent=ratioObj?(ratioObj.ratio*100).toFixed(0)+'%':'自訂';

  $('loanRateMirror').value=(parseFloat(loanRateEl.value)||0).toFixed(2); // 鏡射
  if(typeof recomputePortfolio==='function') recomputePortfolio();
}
['input','change'].forEach(evt=>{
  principalEl.addEventListener(evt,computeCashflow);
  loanEl.addEventListener(evt,computeCashflow);
  rateEl.addEventListener(evt,computeCashflow);
  loanRateEl.addEventListener(evt,computeCashflow);
  ratioEl.addEventListener(evt,computeCashflow);
});

/* ============ Export ============ */
async function exportCurrent(type='png'){
  document.body.classList.add('exporting'); await new Promise(r=>setTimeout(r,0));
  const panel=document.querySelector('.tabpanel.active');
  const canvas=await html2canvas(panel,{backgroundColor:'#0A1221',scale:2,useCORS:true});
  document.body.classList.remove('exporting');
  if(type==='png'){const a=document.createElement('a'); a.download=(panel.id==='panel-cash'?'配息試算':'投組年化')+'.png'; a.href=canvas.toDataURL('image/png'); a.click();}
  else{ const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'pt',format:'a4',orientation:'p'}); const w=pdf.internal.pageSize.getWidth(); const imgW=w; const imgH=canvas.height*(imgW/canvas.width); pdf.addImage(canvas.toDataURL('image/jpeg',0.95),'JPEG',0,20,imgW,imgH); pdf.save((panel.id==='panel-cash'?'配息試算':'投組年化')+'.pdf'); }
}
$('btnPng').addEventListener('click',()=>exportCurrent('png'));
$('btnPdf').addEventListener('click',()=>exportCurrent('pdf'));

/* ============ Preset toolbar events ============ */
$('applyPresetBtn').addEventListener('click',()=>{
  const id=$('presetSelect').value; if(!id){ alert('請先選擇常用基金'); return; }
  const row=parseInt($('targetRow').value,10)||0;
  applyPresetToRow(row,id);
});

/* ============ Bootstrap ============ */
(async function init(){
  await loadCatalog();
  populatePresetSelect();
  bindFundInputs();
  // 初次順序：先投組，再現金流（避免順序問題）
  recomputePortfolio();
  computeCashflow();
})();
</script>
</body>
</html>
